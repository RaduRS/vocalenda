[2025-09-15T11:26:26.685Z] 💓 KEEPALIVE: Sent to Deepgram
📨 Received Deepgram JSON message: {"type":"ConversationText","role":"assistant","content":"Could you please confirm your full name and the exact date and time of your current appointment for security?"}...
Message string: {"type":"ConversationText","role":"assistant","content":"Could you please confirm your full name and the exact date and time of your current appointment for security?"}
[2025-09-15T11:26:26.893Z] 📨 JSON MESSAGE FROM DEEPGRAM: {"type":"ConversationText","role":"assistant","content":"Could you please confirm your full name and the exact date and time of your current appointment for security?"}
[2025-09-15T11:26:26.893Z] === PARSED DEEPGRAM JSON ===
{
  "type": "ConversationText",
  "role": "assistant",
  "content": "Could you please confirm your full name and the exact date and time of your current appointment for security?"
}
[2025-09-15T11:26:26.893Z] === END PARSED JSON ===
[2025-09-15T11:26:26.893Z] 🎯 DEEPGRAM EVENT TYPE: ConversationText
[2025-09-15T11:26:26.893Z] 💭 CONVERSATION_TEXT: Could you please confirm your full name and the exact date and time of your current appointment for security?
[2025-09-15T11:26:26.893Z] 🔍 ConversationText role: 'assistant' -> Speaker: 'AI'
📝 TRANSCRIPT: Added AI: Could you please confirm your full name and the exact date and time of your current appointment for security?
📨 Received Deepgram JSON message: {"type":"History","role":"assistant","content":"Could you please confirm your full name and the exact date and time of your current appointment for security?"}...
Message string: {"type":"History","role":"assistant","content":"Could you please confirm your full name and the exact date and time of your current appointment for security?"}
[2025-09-15T11:26:26.893Z] 📨 JSON MESSAGE FROM DEEPGRAM: {"type":"History","role":"assistant","content":"Could you please confirm your full name and the exact date and time of your current appointment for security?"}
[2025-09-15T11:26:26.893Z] === PARSED DEEPGRAM JSON ===
{
  "type": "History",
  "role": "assistant",
  "content": "Could you please confirm your full name and the exact date and time of your current appointment for security?"
}
[2025-09-15T11:26:26.893Z] === END PARSED JSON ===
[2025-09-15T11:26:26.893Z] 🎯 DEEPGRAM EVENT TYPE: History
[2025-09-15T11:26:26.893Z] 📜 HISTORY: Message logged
[2025-09-15T11:26:26.893Z] 🔍 History role: 'assistant' -> Speaker: 'AI'
📝 TRANSCRIPT: Skipping duplicate AI: Could you please confirm your full name and the exact date and time of your current appointment for security?
[2025-09-15T11:26:26.893Z] 📝 Added transcript: [AI] Could you please confirm your full name and the exact date and time of your current appointment for security?
[2025-09-15T11:26:26.893Z] 🎵 Starting audio stream - feeding buffer
📨 Received Deepgram JSON message: {"type":"AgentAudioDone"}...
Message string: {"type":"AgentAudioDone"}
[2025-09-15T11:26:27.632Z] 📨 JSON MESSAGE FROM DEEPGRAM: {"type":"AgentAudioDone"}
[2025-09-15T11:26:27.632Z] === PARSED DEEPGRAM JSON ===
{
  "type": "AgentAudioDone"
}
[2025-09-15T11:26:27.632Z] === END PARSED JSON ===
[2025-09-15T11:26:27.632Z] 🎯 DEEPGRAM EVENT TYPE: AgentAudioDone
[2025-09-15T11:26:27.632Z] 🔇 AGENT_AUDIO_DONE: AI finished sending audio
[2025-09-15T11:26:27.632Z] 🔇 SILENCE: Started tracking
[2025-09-15T11:26:27.632Z] ✅ Agent speech ended. Pacer will now send silence until next utterance.
[2025-09-15T11:26:27.632Z] 🔇 SILENCE_CHECK: 1000ms of silence
[2025-09-15T11:26:27.632Z] 🔇 SILENCE_CHECK: 2001ms of silence
[2025-09-15T11:26:27.632Z] 🔇 SILENCE_CHECK: 3002ms of silence
[2025-09-15T11:26:30.686Z] 💓 KEEPALIVE: Sent to Deepgram
[2025-09-15T11:26:27.632Z] 🔇 SILENCE_CHECK: 4002ms of silence
[2025-09-15T11:26:27.632Z] 🔇 SILENCE_CHECK: 5002ms of silence
[2025-09-15T11:26:27.632Z] 🔇 SILENCE_CHECK: 6003ms of silence
[2025-09-15T11:26:27.632Z] 🔇 SILENCE_CHECK: 7003ms of silence
[2025-09-15T11:26:34.687Z] 💓 KEEPALIVE: Sent to Deepgram
📨 Received Deepgram JSON message: {"type":"UserStartedSpeaking"}...
Message string: {"type":"UserStartedSpeaking"}
[2025-09-15T11:26:35.051Z] 📨 JSON MESSAGE FROM DEEPGRAM: {"type":"UserStartedSpeaking"}
[2025-09-15T11:26:35.051Z] === PARSED DEEPGRAM JSON ===
{
  "type": "UserStartedSpeaking"
}
[2025-09-15T11:26:35.051Z] === END PARSED JSON ===
[2025-09-15T11:26:35.051Z] 🎯 DEEPGRAM EVENT TYPE: UserStartedSpeaking
[2025-09-15T11:26:35.051Z] 🎤 USER_STARTED_SPEAKING: User began speaking
[2025-09-15T11:26:35.051Z] 🔄 BARGE_IN: Cleared Twilio audio queue for user speech
[2025-09-15T11:26:35.051Z] 🔄 SILENCE_RESET: User speaking, silence tracking reset
📨 Received Deepgram JSON message: {"type":"ConversationText","role":"user","content":"You just made my appointment right now."}...
Message string: {"type":"ConversationText","role":"user","content":"You just made my appointment right now."}
[2025-09-15T11:26:36.597Z] 📨 JSON MESSAGE FROM DEEPGRAM: {"type":"ConversationText","role":"user","content":"You just made my appointment right now."}
[2025-09-15T11:26:36.597Z] === PARSED DEEPGRAM JSON ===
{
  "type": "ConversationText",
  "role": "user",
  "content": "You just made my appointment right now."
}
[2025-09-15T11:26:36.597Z] === END PARSED JSON ===
[2025-09-15T11:26:36.597Z] 🎯 DEEPGRAM EVENT TYPE: ConversationText
[2025-09-15T11:26:36.597Z] 💭 CONVERSATION_TEXT: You just made my appointment right now.
[2025-09-15T11:26:36.597Z] 🔍 ConversationText role: 'user' -> Speaker: 'User'
📝 TRANSCRIPT: Added User: You just made my appointment right now.
📨 Received Deepgram JSON message: {"type":"History","role":"user","content":"You just made my appointment right now."}...
Message string: {"type":"History","role":"user","content":"You just made my appointment right now."}
[2025-09-15T11:26:36.603Z] 📨 JSON MESSAGE FROM DEEPGRAM: {"type":"History","role":"user","content":"You just made my appointment right now."}
[2025-09-15T11:26:36.603Z] === PARSED DEEPGRAM JSON ===
{
  "type": "History",
  "role": "user",
  "content": "You just made my appointment right now."
}
[2025-09-15T11:26:36.603Z] === END PARSED JSON ===
[2025-09-15T11:26:36.603Z] 🎯 DEEPGRAM EVENT TYPE: History
[2025-09-15T11:26:36.603Z] 📜 HISTORY: Message logged
[2025-09-15T11:26:36.603Z] 🔍 History role: 'user' -> Speaker: 'User'
📝 TRANSCRIPT: Skipping duplicate User: You just made my appointment right now.
[2025-09-15T11:26:36.603Z] 📝 Added transcript: [User] You just made my appointment right now.
📨 Received Deepgram JSON message: {"type":"UserStartedSpeaking"}...
Message string: {"type":"UserStartedSpeaking"}
[2025-09-15T11:26:37.517Z] 📨 JSON MESSAGE FROM DEEPGRAM: {"type":"UserStartedSpeaking"}
[2025-09-15T11:26:37.517Z] === PARSED DEEPGRAM JSON ===
{
  "type": "UserStartedSpeaking"
}
[2025-09-15T11:26:37.517Z] === END PARSED JSON ===
[2025-09-15T11:26:37.517Z] 🎯 DEEPGRAM EVENT TYPE: UserStartedSpeaking
[2025-09-15T11:26:37.517Z] 🎤 USER_STARTED_SPEAKING: User began speaking
[2025-09-15T11:26:37.517Z] 🔄 BARGE_IN: Cleared Twilio audio queue for user speech
[2025-09-15T11:26:37.517Z] 🔄 SILENCE_RESET: User speaking, silence tracking reset
📨 Received Deepgram JSON message: {"type":"ConversationText","role":"user","content":"It was"}...
Message string: {"type":"ConversationText","role":"user","content":"It was"}
[2025-09-15T11:26:37.523Z] 📨 JSON MESSAGE FROM DEEPGRAM: {"type":"ConversationText","role":"user","content":"It was"}
[2025-09-15T11:26:37.523Z] === PARSED DEEPGRAM JSON ===
{
  "type": "ConversationText",
  "role": "user",
  "content": "It was"
}
[2025-09-15T11:26:37.523Z] === END PARSED JSON ===
[2025-09-15T11:26:37.523Z] 🎯 DEEPGRAM EVENT TYPE: ConversationText
[2025-09-15T11:26:37.523Z] 💭 CONVERSATION_TEXT: It was
[2025-09-15T11:26:37.523Z] 🔍 ConversationText role: 'user' -> Speaker: 'User'
📝 TRANSCRIPT: Added User: It was
📨 Received Deepgram JSON message: {"type":"History","role":"user","content":"It was"}...
Message string: {"type":"History","role":"user","content":"It was"}
[2025-09-15T11:26:37.523Z] 📨 JSON MESSAGE FROM DEEPGRAM: {"type":"History","role":"user","content":"It was"}
[2025-09-15T11:26:37.523Z] === PARSED DEEPGRAM JSON ===
{
  "type": "History",
  "role": "user",
  "content": "It was"
}
[2025-09-15T11:26:37.523Z] === END PARSED JSON ===
[2025-09-15T11:26:37.523Z] 🎯 DEEPGRAM EVENT TYPE: History
[2025-09-15T11:26:37.523Z] 📜 HISTORY: Message logged
[2025-09-15T11:26:37.523Z] 🔍 History role: 'user' -> Speaker: 'User'
📝 TRANSCRIPT: Skipping duplicate User: It was
[2025-09-15T11:26:37.523Z] 📝 Added transcript: [User] It was
📨 Received Deepgram JSON message: {"type":"UserStartedSpeaking"}...
Message string: {"type":"UserStartedSpeaking"}
[2025-09-15T11:26:38.331Z] 📨 JSON MESSAGE FROM DEEPGRAM: {"type":"UserStartedSpeaking"}
[2025-09-15T11:26:38.331Z] === PARSED DEEPGRAM JSON ===
{
  "type": "UserStartedSpeaking"
}
[2025-09-15T11:26:38.331Z] === END PARSED JSON ===
[2025-09-15T11:26:38.331Z] 🎯 DEEPGRAM EVENT TYPE: UserStartedSpeaking
[2025-09-15T11:26:38.331Z] 🎤 USER_STARTED_SPEAKING: User began speaking
[2025-09-15T11:26:38.331Z] 🔄 BARGE_IN: Cleared Twilio audio queue for user speech
[2025-09-15T11:26:38.331Z] 🔄 SILENCE_RESET: User speaking, silence tracking reset
[2025-09-15T11:26:38.687Z] 💓 KEEPALIVE: Sent to Deepgram
📨 Received Deepgram JSON message: {"type":"ConversationText","role":"user","content":"Mark at one thirty on Thursday."}...
Message string: {"type":"ConversationText","role":"user","content":"Mark at one thirty on Thursday."}
[2025-09-15T11:26:40.663Z] 📨 JSON MESSAGE FROM DEEPGRAM: {"type":"ConversationText","role":"user","content":"Mark at one thirty on Thursday."}
[2025-09-15T11:26:40.663Z] === PARSED DEEPGRAM JSON ===
{
  "type": "ConversationText",
  "role": "user",
  "content": "Mark at one thirty on Thursday."
}
[2025-09-15T11:26:40.663Z] === END PARSED JSON ===
[2025-09-15T11:26:40.663Z] 🎯 DEEPGRAM EVENT TYPE: ConversationText
[2025-09-15T11:26:40.663Z] 💭 CONVERSATION_TEXT: Mark at one thirty on Thursday.
[2025-09-15T11:26:40.663Z] 🔍 ConversationText role: 'user' -> Speaker: 'User'
📝 TRANSCRIPT: Added User: Mark at one thirty on Thursday.
📨 Received Deepgram JSON message: {"type":"History","role":"user","content":"Mark at one thirty on Thursday."}...
Message string: {"type":"History","role":"user","content":"Mark at one thirty on Thursday."}
[2025-09-15T11:26:40.683Z] 📨 JSON MESSAGE FROM DEEPGRAM: {"type":"History","role":"user","content":"Mark at one thirty on Thursday."}
[2025-09-15T11:26:40.683Z] === PARSED DEEPGRAM JSON ===
{
  "type": "History",
  "role": "user",
  "content": "Mark at one thirty on Thursday."
}
[2025-09-15T11:26:40.683Z] === END PARSED JSON ===
[2025-09-15T11:26:40.683Z] 🎯 DEEPGRAM EVENT TYPE: History
[2025-09-15T11:26:40.683Z] 📜 HISTORY: Message logged
[2025-09-15T11:26:40.683Z] 🔍 History role: 'user' -> Speaker: 'User'
📝 TRANSCRIPT: Skipping duplicate User: Mark at one thirty on Thursday.
[2025-09-15T11:26:40.683Z] 📝 Added transcript: [User] Mark at one thirty on Thursday.
📨 Received Deepgram JSON message: {"type":"FunctionCallRequest","functions":[{"id":"call_DX3yfYzOyD8TOEZxvBroUh8g","name":"update_booking","arguments":"{\"new_date\":\"2025-09-16\",\"new_time\":\"13:30\"}","client_side":true}]}...
Message string: {"type":"FunctionCallRequest","functions":[{"id":"call_DX3yfYzOyD8TOEZxvBroUh8g","name":"update_booking","arguments":"{\"new_date\":\"2025-09-16\",\"new_time\":\"13:30\"}","client_side":true}]}
[2025-09-15T11:26:41.465Z] 📨 JSON MESSAGE FROM DEEPGRAM: {"type":"FunctionCallRequest","functions":[{"id":"call_DX3yfYzOyD8TOEZxvBroUh8g","name":"update_booking","arguments":"{\"new_date\":\"2025-09-16\",\"new_time\":\"13:30\"}","client_side":true}]}
[2025-09-15T11:26:41.465Z] === PARSED DEEPGRAM JSON ===
{
  "type": "FunctionCallRequest",
  "functions": [
    {
      "id": "call_DX3yfYzOyD8TOEZxvBroUh8g",
      "name": "update_booking",
      "arguments": "{\"new_date\":\"2025-09-16\",\"new_time\":\"13:30\"}",
      "client_side": true
    }
  ]
}
[2025-09-15T11:26:41.465Z] === END PARSED JSON ===
[2025-09-15T11:26:41.465Z] 🎯 DEEPGRAM EVENT TYPE: FunctionCallRequest
[2025-09-15T11:26:41.465Z] 🚨🚨 FUNCTION_CALL_REQUEST DETECTED! 🚨🚨
[2025-09-15T11:26:41.465Z] ✅ SUCCESS: AI requesting function calls!
[2025-09-15T11:26:41.465Z] 📋 Functions: [
  {
    "id": "call_DX3yfYzOyD8TOEZxvBroUh8g",
    "name": "update_booking",
    "arguments": "{\"new_date\":\"2025-09-16\",\"new_time\":\"13:30\"}",
    "client_side": true
  }
]
[2025-09-15T11:26:41.465Z] ⏸️ SILENCE: Pausing timer - Processing function calls
[2025-09-15T11:26:41.465Z] ⏸️ KEEPALIVE: Paused for function processing
[2025-09-15T11:26:41.465Z] 🔧 Processing function: update_booking
[2025-09-15T11:26:41.465Z] 🔧 CALLING: handleFunctionCall for update_booking...
📝 Session updated for call CA0bd798eef180ff206bb5fed49ab72536: {
  callerPhone: '+447468306825',
  lastCheckedDate: '2025-09-16',
  lastCheckedTimestamp: '2025-09-15T11:26:02.146Z',
  customerName: 'Mark',
  lastBookingDate: '2025-09-16',
  lastBookingTime: '13:30',
  lastServiceId: 'haircut',
  lastServiceName: 'haircut',
  lastServiceDuration: 30,
  bookings: [
    {
      customerName: 'Mark',
      date: '2025-09-18',
      time: '13:30',
      serviceId: 'haircut',
      serviceName: 'haircut',
      serviceDuration: 30,
      appointmentId: 'e0f0cf83-ddaa-40b9-aa2d-4005aa012b2d',
      type: 'create'
    },
    {
      customerName: 'Mark',
      currentDate: '2025-09-18',
      currentTime: '13:30',
      newDate: '2025-09-16',
      newTime: '13:30',
      newServiceId: undefined,
      type: 'update'
    }
  ],
  lastAppointmentId: 'e0f0cf83-ddaa-40b9-aa2d-4005aa012b2d'
}
[2025-09-15T11:26:41.465Z] 🚀 STARTING handleFunctionCall
[2025-09-15T11:26:41.465Z] 🔧 Function call received: {
  "function_name": "update_booking",
  "function_call_id": "call_DX3yfYzOyD8TOEZxvBroUh8g",
  "parameters": {
    "new_date": "2025-09-16",
    "new_time": "13:30"
  }
}
[2025-09-15T11:26:41.465Z] 📋 Function name: update_booking
[2025-09-15T11:26:41.465Z] 📊 Parameters: {
  "new_date": "2025-09-16",
  "new_time": "13:30"
}
[2025-09-15T11:26:41.465Z] 🏢 Business config exists: true
[2025-09-15T11:26:41.465Z] 🌐 WebSocket state: 1
🔧 Function call received: {
  "function_name": "update_booking",
  "function_call_id": "call_DX3yfYzOyD8TOEZxvBroUh8g",
  "parameters": {
    "new_date": "2025-09-16",
    "new_time": "13:30"
  }
}
📝 updateBooking called with params: {
  "new_date": "2025-09-16",
  "new_time": "13:30"
}
📋 Session data: {
  callerPhone: '+447468306825',
  lastCheckedDate: '2025-09-16',
  lastCheckedTimestamp: '2025-09-15T11:26:02.146Z',
  customerName: 'Mark',
  lastBookingDate: '2025-09-16',
  lastBookingTime: '13:30',
  lastServiceId: 'haircut',
  lastServiceName: 'haircut',
  lastServiceDuration: 30,
  bookings: [
    {
      customerName: 'Mark',
      date: '2025-09-18',
      time: '13:30',
      serviceId: 'haircut',
      serviceName: 'haircut',
      serviceDuration: 30,
      appointmentId: 'e0f0cf83-ddaa-40b9-aa2d-4005aa012b2d',
      type: 'create'
    },
    {
      customerName: 'Mark',
      currentDate: '2025-09-18',
      currentTime: '13:30',
      newDate: '2025-09-16',
      newTime: '13:30',
      newServiceId: undefined,
      type: 'update'
    }
  ],
  lastAppointmentId: 'e0f0cf83-ddaa-40b9-aa2d-4005aa012b2d'
}
🎯 Identified target booking: {
  appointmentId: 'e0f0cf83-ddaa-40b9-aa2d-4005aa012b2d',
  service: 'haircut',
  date: '2025-09-18',
  time: '13:30'
}
🔄 Using customer info: {
  customerName: 'Mark',
  currentDate: '2025-09-18',
  currentTime: '13:30'
}
📞 Caller phone: +447468306825
👤 Customer: Mark
📅 Booking: 2025-09-18 at 13:30
📝 Session updated for call CA0bd798eef180ff206bb5fed49ab72536: {
  callerPhone: '+447468306825',
  lastCheckedDate: '2025-09-16',
  lastCheckedTimestamp: '2025-09-15T11:26:02.146Z',
  customerName: 'Mark',
  lastBookingDate: '2025-09-16',
  lastBookingTime: '13:30',
  lastServiceId: 'haircut',
  lastServiceName: 'haircut',
  lastServiceDuration: 30,
  bookings: [
    {
      customerName: 'Mark',
      currentDate: '2025-09-18',
      currentTime: '13:30',
      newDate: '2025-09-16',
      newTime: '13:30',
      newServiceId: undefined,
      type: 'update'
    },
    {
      customerName: 'Mark',
      date: '2025-09-18',
      time: '13:30',
      serviceId: 'haircut',
      serviceName: 'haircut',
      serviceDuration: 30,
      appointmentId: 'e0f0cf83-ddaa-40b9-aa2d-4005aa012b2d',
      type: 'create'
    },
    {
      customerName: 'Mark',
      currentDate: '2025-09-18',
      currentTime: '13:30',
      newDate: '2025-09-16',
      newTime: '13:30',
      newServiceId: undefined,
      type: 'update'
    }
  ],
  lastAppointmentId: 'e0f0cf83-ddaa-40b9-aa2d-4005aa012b2d'
}
📦 Update request body: {
  "business_id": "1bb3c552-053f-40c4-b3f2-bdb51af87b52",
  "customer_name": "Mark",
  "current_date": "2025-09-18",
  "current_time": "13:30",
  "caller_phone": "+447468306825",
  "new_date": "2025-09-16",
  "new_time": "13:30"
}
📨 Received Deepgram JSON message: {"type":"UserStartedSpeaking"}...
Message string: {"type":"UserStartedSpeaking"}
[2025-09-15T11:26:41.611Z] 📨 JSON MESSAGE FROM DEEPGRAM: {"type":"UserStartedSpeaking"}
[2025-09-15T11:26:41.611Z] === PARSED DEEPGRAM JSON ===
{
  "type": "UserStartedSpeaking"
}
[2025-09-15T11:26:41.611Z] === END PARSED JSON ===
[2025-09-15T11:26:41.611Z] 🎯 DEEPGRAM EVENT TYPE: UserStartedSpeaking
[2025-09-15T11:26:41.611Z] 🎤 USER_STARTED_SPEAKING: User began speaking
[2025-09-15T11:26:41.611Z] 🔄 BARGE_IN: Cleared Twilio audio queue for user speech
[2025-09-15T11:26:41.611Z] 🔄 SILENCE_RESET: User speaking, silence tracking reset
📨 Received Deepgram JSON message: {"type":"ConversationText","role":"user","content":"Haircut."}...
Message string: {"type":"ConversationText","role":"user","content":"Haircut."}
[2025-09-15T11:26:41.715Z] 📨 JSON MESSAGE FROM DEEPGRAM: {"type":"ConversationText","role":"user","content":"Haircut."}
[2025-09-15T11:26:41.715Z] === PARSED DEEPGRAM JSON ===
{
  "type": "ConversationText",
  "role": "user",
  "content": "Haircut."
}
[2025-09-15T11:26:41.715Z] === END PARSED JSON ===
[2025-09-15T11:26:41.715Z] 🎯 DEEPGRAM EVENT TYPE: ConversationText
[2025-09-15T11:26:41.715Z] 💭 CONVERSATION_TEXT: Haircut.
[2025-09-15T11:26:41.715Z] 🔍 ConversationText role: 'user' -> Speaker: 'User'
📝 TRANSCRIPT: Added User: Haircut.
📨 Received Deepgram JSON message: {"type":"History","role":"user","content":"Haircut."}...
Message string: {"type":"History","role":"user","content":"Haircut."}
[2025-09-15T11:26:41.723Z] 📨 JSON MESSAGE FROM DEEPGRAM: {"type":"History","role":"user","content":"Haircut."}
[2025-09-15T11:26:41.723Z] === PARSED DEEPGRAM JSON ===
{
  "type": "History",
  "role": "user",
  "content": "Haircut."
}
[2025-09-15T11:26:41.723Z] === END PARSED JSON ===
[2025-09-15T11:26:41.723Z] 🎯 DEEPGRAM EVENT TYPE: History
[2025-09-15T11:26:41.723Z] 📜 HISTORY: Message logged
[2025-09-15T11:26:41.723Z] 🔍 History role: 'user' -> Speaker: 'User'
📝 TRANSCRIPT: Skipping duplicate User: Haircut.
[2025-09-15T11:26:41.723Z] 📝 Added transcript: [User] Haircut.
❌ Update booking API error: 404 {"error":"No booking found for Mark on 2025-09-18 at 13:30. Please check the exact name, date, and time."}
✅ Sending update_booking response to Deepgram
✅ Function response sent successfully to Deepgram
🔄 Waiting for Deepgram to process the response...
📨 Received Deepgram JSON message: {"type":"FunctionCallRequest","functions":[{"id":"call_eR870xyN5qsph62GBEAOhl4Q","name":"update_booking","arguments":"{\"new_date\":\"2025-09-16\",\"new_time\":\"13:30\"}","client_side":true}]}...
Message string: {"type":"FunctionCallRequest","functions":[{"id":"call_eR870xyN5qsph62GBEAOhl4Q","name":"update_booking","arguments":"{\"new_date\":\"2025-09-16\",\"new_time\":\"13:30\"}","client_side":true}]}
[2025-09-15T11:26:42.737Z] 📨 JSON MESSAGE FROM DEEPGRAM: {"type":"FunctionCallRequest","functions":[{"id":"call_eR870xyN5qsph62GBEAOhl4Q","name":"update_booking","arguments":"{\"new_date\":\"2025-09-16\",\"new_time\":\"13:30\"}","client_side":true}]}
[2025-09-15T11:26:42.737Z] === PARSED DEEPGRAM JSON ===
{
  "type": "FunctionCallRequest",
  "functions": [
    {
      "id": "call_eR870xyN5qsph62GBEAOhl4Q",
      "name": "update_booking",
      "arguments": "{\"new_date\":\"2025-09-16\",\"new_time\":\"13:30\"}",
      "client_side": true
    }
  ]
}
[2025-09-15T11:26:42.737Z] === END PARSED JSON ===
[2025-09-15T11:26:42.737Z] 🎯 DEEPGRAM EVENT TYPE: FunctionCallRequest
[2025-09-15T11:26:42.737Z] 🚨🚨 FUNCTION_CALL_REQUEST DETECTED! 🚨🚨
[2025-09-15T11:26:42.737Z] ✅ SUCCESS: AI requesting function calls!
[2025-09-15T11:26:42.737Z] 📋 Functions: [
  {
    "id": "call_eR870xyN5qsph62GBEAOhl4Q",
    "name": "update_booking",
    "arguments": "{\"new_date\":\"2025-09-16\",\"new_time\":\"13:30\"}",
    "client_side": true
  }
]
[2025-09-15T11:26:42.737Z] ⏸️ SILENCE: Pausing timer - Processing function calls
[2025-09-15T11:26:42.737Z] ⏸️ KEEPALIVE: Paused for function processing
[2025-09-15T11:26:42.737Z] 🔧 Processing function: update_booking
[2025-09-15T11:26:42.737Z] 🔧 CALLING: handleFunctionCall for update_booking...
📝 Session updated for call CA0bd798eef180ff206bb5fed49ab72536: {
  callerPhone: '+447468306825',
  lastCheckedDate: '2025-09-16',
  lastCheckedTimestamp: '2025-09-15T11:26:02.146Z',
  customerName: 'Mark',
  lastBookingDate: '2025-09-16',
  lastBookingTime: '13:30',
  lastServiceId: 'haircut',
  lastServiceName: 'haircut',
  lastServiceDuration: 30,
  bookings: [
    {
      customerName: 'Mark',
      currentDate: '2025-09-18',
      currentTime: '13:30',
      newDate: '2025-09-16',
      newTime: '13:30',
      newServiceId: undefined,
      type: 'update'
    },
    {
      customerName: 'Mark',
      date: '2025-09-18',
      time: '13:30',
      serviceId: 'haircut',
      serviceName: 'haircut',
      serviceDuration: 30,
      appointmentId: 'e0f0cf83-ddaa-40b9-aa2d-4005aa012b2d',
      type: 'create'
    },
    {
      customerName: 'Mark',
      currentDate: '2025-09-18',
      currentTime: '13:30',
      newDate: '2025-09-16',
      newTime: '13:30',
      newServiceId: undefined,
      type: 'update'
    }
  ],
  lastAppointmentId: 'e0f0cf83-ddaa-40b9-aa2d-4005aa012b2d'
}
[2025-09-15T11:26:42.737Z] 🚀 STARTING handleFunctionCall
[2025-09-15T11:26:42.737Z] 🔧 Function call received: {
  "function_name": "update_booking",
  "function_call_id": "call_eR870xyN5qsph62GBEAOhl4Q",
  "parameters": {
    "new_date": "2025-09-16",
    "new_time": "13:30"
  }
}
[2025-09-15T11:26:42.737Z] 📋 Function name: update_booking
[2025-09-15T11:26:42.737Z] 📊 Parameters: {
  "new_date": "2025-09-16",
  "new_time": "13:30"
}
[2025-09-15T11:26:42.737Z] 🏢 Business config exists: true
[2025-09-15T11:26:42.737Z] 🌐 WebSocket state: 1
🔧 Function call received: {
  "function_name": "update_booking",
  "function_call_id": "call_eR870xyN5qsph62GBEAOhl4Q",
  "parameters": {
    "new_date": "2025-09-16",
    "new_time": "13:30"
  }
}
📝 updateBooking called with params: {
  "new_date": "2025-09-16",
  "new_time": "13:30"
}
📋 Session data: {
  callerPhone: '+447468306825',
  lastCheckedDate: '2025-09-16',
  lastCheckedTimestamp: '2025-09-15T11:26:02.146Z',
  customerName: 'Mark',
  lastBookingDate: '2025-09-16',
  lastBookingTime: '13:30',
  lastServiceId: 'haircut',
  lastServiceName: 'haircut',
  lastServiceDuration: 30,
  bookings: [
    {
      customerName: 'Mark',
      currentDate: '2025-09-18',
      currentTime: '13:30',
      newDate: '2025-09-16',
      newTime: '13:30',
      newServiceId: undefined,
      type: 'update'
    },
    {
      customerName: 'Mark',
      date: '2025-09-18',
      time: '13:30',
      serviceId: 'haircut',
      serviceName: 'haircut',
      serviceDuration: 30,
      appointmentId: 'e0f0cf83-ddaa-40b9-aa2d-4005aa012b2d',
      type: 'create'
    },
    {
      customerName: 'Mark',
      currentDate: '2025-09-18',
      currentTime: '13:30',
      newDate: '2025-09-16',
      newTime: '13:30',
      newServiceId: undefined,
      type: 'update'
    }
  ],
  lastAppointmentId: 'e0f0cf83-ddaa-40b9-aa2d-4005aa012b2d'
}
🎯 Identified target booking: {
  appointmentId: 'e0f0cf83-ddaa-40b9-aa2d-4005aa012b2d',
  service: 'haircut',
  date: '2025-09-18',
  time: '13:30'
}
🔄 Using customer info: {
  customerName: 'Mark',
  currentDate: '2025-09-18',
  currentTime: '13:30'
}
📞 Caller phone: +447468306825
👤 Customer: Mark
📅 Booking: 2025-09-18 at 13:30
📝 Session updated for call CA0bd798eef180ff206bb5fed49ab72536: {
  callerPhone: '+447468306825',
  lastCheckedDate: '2025-09-16',
  lastCheckedTimestamp: '2025-09-15T11:26:02.146Z',
  customerName: 'Mark',
  lastBookingDate: '2025-09-16',
  lastBookingTime: '13:30',
  lastServiceId: 'haircut',
  lastServiceName: 'haircut',
  lastServiceDuration: 30,
  bookings: [
    {
      customerName: 'Mark',
      currentDate: '2025-09-18',
      currentTime: '13:30',
      newDate: '2025-09-16',
      newTime: '13:30',
      newServiceId: undefined,
      type: 'update'
    },
    {
      customerName: 'Mark',
      date: '2025-09-18',
      time: '13:30',
      serviceId: 'haircut',
      serviceName: 'haircut',
      serviceDuration: 30,
      appointmentId: 'e0f0cf83-ddaa-40b9-aa2d-4005aa012b2d',
      type: 'create'
    },
    {
      customerName: 'Mark',
      currentDate: '2025-09-18',
      currentTime: '13:30',
      newDate: '2025-09-16',
      newTime: '13:30',
      newServiceId: undefined,
      type: 'update'
    },
    {
      customerName: 'Mark',
      currentDate: '2025-09-18',
      currentTime: '13:30',
      newDate: '2025-09-16',
      newTime: '13:30',
      newServiceId: undefined,
      type: 'update'
    }
  ],
  lastAppointmentId: 'e0f0cf83-ddaa-40b9-aa2d-4005aa012b2d'
}
📦 Update request body: {
  "business_id": "1bb3c552-053f-40c4-b3f2-bdb51af87b52",
  "customer_name": "Mark",
  "current_date": "2025-09-18",
  "current_time": "13:30",
  "caller_phone": "+447468306825",
  "new_date": "2025-09-16",
  "new_time": "13:30"
}
[2025-09-15T11:26:41.465Z] ✅ COMPLETED: handleFunctionCall for update_booking
[2025-09-15T11:26:43.317Z] ▶️ KEEPALIVE: Resumed after function processing
[2025-09-15T11:26:41.465Z] ▶️ SILENCE: Resuming timer - Function processing completed
❌ Update booking API error: 404 {"error":"No booking found for Mark on 2025-09-18 at 13:30. Please check the exact name, date, and time."}
✅ Sending update_booking response to Deepgram
✅ Function response sent successfully to Deepgram
🔄 Waiting for Deepgram to process the response...
📨 Received Deepgram JSON message: {"type":"History","function_calls":[{"id":"call_eR870xyN5qsph62GBEAOhl4Q","name":"update_booking","client_side":true,"arguments":"{\"new_date\":\"2025-09-16\",\"new_time\":\"13:30\"}","response":"{\"e...
Message string: {"type":"History","function_calls":[{"id":"call_eR870xyN5qsph62GBEAOhl4Q","name":"update_booking","client_side":true,"arguments":"{\"new_date\":\"2025-09-16\",\"new_time\":\"13:30\"}","response":"{\"error\":\"Failed to update booking: {\\\"error\\\":\\\"No booking found for Mark on 2025-09-18 at 13:30. Please check the exact name, date, and time.\\\"}\"}"}]}
[2025-09-15T11:26:43.676Z] 📨 JSON MESSAGE FROM DEEPGRAM: {"type":"History","function_calls":[{"id":"call_eR870xyN5qsph62GBEAOhl4Q","name":"update_booking","client_side":true,"arguments":"{\"new_date\":\"2025-09-16\",\"new_time\":\"13:30\"}","response":"{\"error\":\"Failed to update booking: {\\\"error\\\":\\\"No booking found for Mark on 2025-09-18 at 13:30. Please check the exact name, date, and time.\\\"}\"}"}]}
[2025-09-15T11:26:43.676Z] === PARSED DEEPGRAM JSON ===
{
  "type": "History",
  "function_calls": [
    {
      "id": "call_eR870xyN5qsph62GBEAOhl4Q",
      "name": "update_booking",
      "client_side": true,
      "arguments": "{\"new_date\":\"2025-09-16\",\"new_time\":\"13:30\"}",
      "response": "{\"error\":\"Failed to update booking: {\\\"error\\\":\\\"No booking found for Mark on 2025-09-18 at 13:30. Please check the exact name, date, and time.\\\"}\"}"
    }
  ]
}
[2025-09-15T11:26:43.676Z] === END PARSED JSON ===
[2025-09-15T11:26:43.676Z] 🎯 DEEPGRAM EVENT TYPE: History
[2025-09-15T11:26:43.676Z] 📜 HISTORY: Message logged
📨 Received Deepgram JSON message: {"type":"ConversationText","role":"assistant","content":"I apologize for this inconvenience."}...
Message string: {"type":"ConversationText","role":"assistant","content":"I apologize for this inconvenience."}
[2025-09-15T11:26:44.435Z] 📨 JSON MESSAGE FROM DEEPGRAM: {"type":"ConversationText","role":"assistant","content":"I apologize for this inconvenience."}
[2025-09-15T11:26:44.435Z] === PARSED DEEPGRAM JSON ===
{
  "type": "ConversationText",
  "role": "assistant",
  "content": "I apologize for this inconvenience."
}
[2025-09-15T11:26:44.435Z] === END PARSED JSON ===
[2025-09-15T11:26:44.435Z] 🎯 DEEPGRAM EVENT TYPE: ConversationText
[2025-09-15T11:26:44.435Z] 💭 CONVERSATION_TEXT: I apologize for this inconvenience.
[2025-09-15T11:26:44.435Z] 🔍 ConversationText role: 'assistant' -> Speaker: 'AI'
📝 TRANSCRIPT: Added AI: I apologize for this inconvenience.
📨 Received Deepgram JSON message: {"type":"History","role":"assistant","content":"I apologize for this inconvenience."}...
Message string: {"type":"History","role":"assistant","content":"I apologize for this inconvenience."}
[2025-09-15T11:26:44.435Z] 📨 JSON MESSAGE FROM DEEPGRAM: {"type":"History","role":"assistant","content":"I apologize for this inconvenience."}
[2025-09-15T11:26:44.435Z] === PARSED DEEPGRAM JSON ===
{
  "type": "History",
  "role": "assistant",
  "content": "I apologize for this inconvenience."
}
[2025-09-15T11:26:44.435Z] === END PARSED JSON ===
[2025-09-15T11:26:44.435Z] 🎯 DEEPGRAM EVENT TYPE: History
[2025-09-15T11:26:44.435Z] 📜 HISTORY: Message logged
[2025-09-15T11:26:44.435Z] 🔍 History role: 'assistant' -> Speaker: 'AI'
📝 TRANSCRIPT: Skipping duplicate AI: I apologize for this inconvenience.
[2025-09-15T11:26:44.435Z] 📝 Added transcript: [AI] I apologize for this inconvenience.
[2025-09-15T11:26:44.436Z] 🎵 Starting audio stream - feeding buffer
[2025-09-15T11:26:42.737Z] ✅ COMPLETED: handleFunctionCall for update_booking
[2025-09-15T11:26:44.525Z] ▶️ KEEPALIVE: Resumed after function processing
[2025-09-15T11:26:42.737Z] ▶️ SILENCE: Resuming timer - Function processing completed
📨 Received Deepgram JSON message: {"type":"FunctionCallRequest","functions":[{"id":"call_Ksf6HzO5tCpa7zVI9sZq2pZe","name":"transfer_to_human","arguments":"{\"reason\":\"customer requested update assistance\"}","client_side":true}]}...
Message string: {"type":"FunctionCallRequest","functions":[{"id":"call_Ksf6HzO5tCpa7zVI9sZq2pZe","name":"transfer_to_human","arguments":"{\"reason\":\"customer requested update assistance\"}","client_side":true}]}
[2025-09-15T11:26:45.103Z] 📨 JSON MESSAGE FROM DEEPGRAM: {"type":"FunctionCallRequest","functions":[{"id":"call_Ksf6HzO5tCpa7zVI9sZq2pZe","name":"transfer_to_human","arguments":"{\"reason\":\"customer requested update assistance\"}","client_side":true}]}
[2025-09-15T11:26:45.103Z] === PARSED DEEPGRAM JSON ===
{
  "type": "FunctionCallRequest",
  "functions": [
    {
      "id": "call_Ksf6HzO5tCpa7zVI9sZq2pZe",
      "name": "transfer_to_human",
      "arguments": "{\"reason\":\"customer requested update assistance\"}",
      "client_side": true
    }
  ]
}
[2025-09-15T11:26:45.103Z] === END PARSED JSON ===
[2025-09-15T11:26:45.103Z] 🎯 DEEPGRAM EVENT TYPE: FunctionCallRequest
[2025-09-15T11:26:45.103Z] 🚨🚨 FUNCTION_CALL_REQUEST DETECTED! 🚨🚨
[2025-09-15T11:26:45.103Z] ✅ SUCCESS: AI requesting function calls!
[2025-09-15T11:26:45.103Z] 📋 Functions: [
  {
    "id": "call_Ksf6HzO5tCpa7zVI9sZq2pZe",
    "name": "transfer_to_human",
    "arguments": "{\"reason\":\"customer requested update assistance\"}",
    "client_side": true
  }
]
[2025-09-15T11:26:45.103Z] ⏸️ SILENCE: Pausing timer - Processing function calls
[2025-09-15T11:26:45.103Z] ⏸️ KEEPALIVE: Paused for function processing
[2025-09-15T11:26:45.103Z] 🔧 Processing function: transfer_to_human
[2025-09-15T11:26:45.103Z] 🔧 CALLING: handleFunctionCall for transfer_to_human...
📝 Session updated for call CA0bd798eef180ff206bb5fed49ab72536: {
  callerPhone: '+447468306825',
  lastCheckedDate: '2025-09-16',
  lastCheckedTimestamp: '2025-09-15T11:26:02.146Z',
  customerName: 'Mark',
  lastBookingDate: '2025-09-16',
  lastBookingTime: '13:30',
  lastServiceId: 'haircut',
  lastServiceName: 'haircut',
  lastServiceDuration: 30,
  bookings: [
    {
      customerName: 'Mark',
      currentDate: '2025-09-18',
      currentTime: '13:30',
      newDate: '2025-09-16',
      newTime: '13:30',
      newServiceId: undefined,
      type: 'update'
    },
    {
      customerName: 'Mark',
      date: '2025-09-18',
      time: '13:30',
      serviceId: 'haircut',
      serviceName: 'haircut',
      serviceDuration: 30,
      appointmentId: 'e0f0cf83-ddaa-40b9-aa2d-4005aa012b2d',
      type: 'create'
    },
    {
      customerName: 'Mark',
      currentDate: '2025-09-18',
      currentTime: '13:30',
      newDate: '2025-09-16',
      newTime: '13:30',
      newServiceId: undefined,
      type: 'update'
    },
    {
      customerName: 'Mark',
      currentDate: '2025-09-18',
      currentTime: '13:30',
      newDate: '2025-09-16',
      newTime: '13:30',
      newServiceId: undefined,
      type: 'update'
    }
  ],
  lastAppointmentId: 'e0f0cf83-ddaa-40b9-aa2d-4005aa012b2d'
}
[2025-09-15T11:26:45.103Z] 🚀 STARTING handleFunctionCall
[2025-09-15T11:26:45.103Z] 🔧 Function call received: {
  "function_name": "transfer_to_human",
  "function_call_id": "call_Ksf6HzO5tCpa7zVI9sZq2pZe",
  "parameters": {
    "reason": "customer requested update assistance"
  }
}
[2025-09-15T11:26:45.103Z] 📋 Function name: transfer_to_human
[2025-09-15T11:26:45.103Z] 📊 Parameters: {
  "reason": "customer requested update assistance"
}
[2025-09-15T11:26:45.103Z] 🏢 Business config exists: true
[2025-09-15T11:26:45.103Z] 🌐 WebSocket state: 1
🔧 Function call received: {
  "function_name": "transfer_to_human",
  "function_call_id": "call_Ksf6HzO5tCpa7zVI9sZq2pZe",
  "parameters": {
    "reason": "customer requested update assistance"
  }
}
📞 Processing human transfer request...
📞 Transfer params: {
  "reason": "customer requested update assistance"
}
📞 Call SID: CA0bd798eef180ff206bb5fed49ab72536
📞 Bypass phone number found: +447469735254
🔄 Initiating transfer from AI to human at +447469735254
📞 Caller: +447468306825 requesting human transfer
📞 Transferring call to: https://www.vocalenda.com/api/voice/transfer?to=%2B447469735254&reason=customer%20requested%20update%20assistance
Media stream stopped
📞 Logging call completion: CA0bd798eef180ff206bb5fed49ab72536
✅ Call CA0bd798eef180ff206bb5fed49ab72536 successfully transferred to +447469735254
✅ Sending transfer_to_human response to Deepgram
✅ Function response sent successfully to Deepgram
🔄 Waiting for Deepgram to process the response...
✅ Call completion logged: CA0bd798eef180ff206bb5fed49ab72536
📨 Received Deepgram JSON message: {"type":"History","function_calls":[{"id":"call_Ksf6HzO5tCpa7zVI9sZq2pZe","name":"transfer_to_human","client_side":true,"arguments":"{\"reason\":\"customer requested update assistance\"}","response":"...
Message string: {"type":"History","function_calls":[{"id":"call_Ksf6HzO5tCpa7zVI9sZq2pZe","name":"transfer_to_human","client_side":true,"arguments":"{\"reason\":\"customer requested update assistance\"}","response":"{\"success\":true,\"transfer_number\":\"+447469735254\",\"message\":\"I'm connecting you to a human representative now. Please hold while I transfer your call.\",\"caller_phone\":\"+447468306825\",\"reason\":\"customer requested update assistance\",\"twilio_call_sid\":\"CA0bd798eef180ff206bb5fed49ab72536\"}"}]}
[2025-09-15T11:26:45.814Z] 📨 JSON MESSAGE FROM DEEPGRAM: {"type":"History","function_calls":[{"id":"call_Ksf6HzO5tCpa7zVI9sZq2pZe","name":"transfer_to_human","client_side":true,"arguments":"{\"reason\":\"customer requested update assistance\"}","response":"{\"success\":true,\"transfer_number\":\"+447469735254\",\"message\":\"I'm connecting you to a human representative now. Please hold while I transfer your call.\",\"caller_phone\":\"+447468306825\",\"reason\":\"customer requested update assistance\",\"twilio_call_sid\":\"CA0bd798eef180ff206bb5fed49ab72536\"}"}]}
[2025-09-15T11:26:45.814Z] === PARSED DEEPGRAM JSON ===
{
  "type": "History",
  "function_calls": [
    {
      "id": "call_Ksf6HzO5tCpa7zVI9sZq2pZe",
      "name": "transfer_to_human",
      "client_side": true,
      "arguments": "{\"reason\":\"customer requested update assistance\"}",
      "response": "{\"success\":true,\"transfer_number\":\"+447469735254\",\"message\":\"I'm connecting you to a human representative now. Please hold while I transfer your call.\",\"caller_phone\":\"+447468306825\",\"reason\":\"customer requested update assistance\",\"twilio_call_sid\":\"CA0bd798eef180ff206bb5fed49ab72536\"}"
    }
  ]
}
[2025-09-15T11:26:45.814Z] === END PARSED JSON ===
[2025-09-15T11:26:45.814Z] 🎯 DEEPGRAM EVENT TYPE: History
[2025-09-15T11:26:45.814Z] 📜 HISTORY: Message logged
✅ Saved transcript for call CA0bd798eef180ff206bb5fed49ab72536 (21 entries)
🔌 Closing Deepgram connection and cleaning up resources
🔇 Persistent pacer cleaned up
🔇 Silence tracking cleaned up
🧹 CLEANUP: Cleaning up connection state for call CA0bd798eef180ff206bb5fed49ab72536
✅ Deepgram connection closed successfully
Deepgram WebSocket closed in initializeDeepgram. Code: 1000, Reason: Call ended
Deepgram WebSocket closed. Code: 1000, Reason: Call ended
Twilio WebSocket connection closed
📞 Logging call completion on close: CA0bd798eef180ff206bb5fed49ab72536
[2025-09-15T11:26:45.103Z] ✅ COMPLETED: handleFunctionCall for transfer_to_human
[2025-09-15T11:26:46.663Z] ▶️ KEEPALIVE: Resumed after function processing
[2025-09-15T11:26:45.103Z] ▶️ SILENCE: Resuming timer - Function processing completed
📊 Call duration calculated: 113 seconds
✅ Call completion logged on close: CA0bd798eef180ff206bb5fed49ab72536
🔌 Closing Deepgram connection and cleaning up resources